<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8" />
        <title>Matrixanzeige</title>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            body {
                margin: 0;
                background: #000;
                font-family: sans-serif;
            }

            #menu {
                position: fixed;
                right: 3px;
                bottom: 50%;
                display: flex;
                justify-content: center;
                align-items: stretch;
                background: #222;
                z-index: 10;
                padding: 10px !important;
                gap: 5px;
                transform: translateY(50%);
                border-radius: 24px;
                flex-wrap: wrap;
                flex-direction: column;
            }

            .buttons {
                display: flex;
                gap: 1px;
                align-items: stretch;
                text-align: center;
                height: 28px;
                border-radius: 14px;
            }

            #matrix-scroll {
                width: calc(100vw - 205px);
                height: 100vh;
                overflow: auto;
                display: flex;
                justify-content: flex-start;
                align-items: flex-start;
                background: #000;
                scrollbar-color: #666 #000;
                scrollbar-width: thin;
            }

            #matrix-scroll::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            #matrix-scroll::-webkit-scrollbar-track {
                background: #000;
            }

            #matrix-scroll::-webkit-scrollbar-thumb {
                background-color: #666;
                border-radius: 5px;
            }

            #matrix-scroll::-webkit-scrollbar-thumb:hover {
                background-color: #888;
            }

            #matrix-scroll.presentation {
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                justify-content: center;
                align-items: center;
                background: #000;
            }

            #matrix.presentation {
                transform-origin: center center;
                will-change: transform;
            }

            #matrix {
                display: grid;
                grid-template-columns: repeat(20, 10px);
                grid-template-rows: repeat(15, 10px);
                gap: 1px;
                padding: 10px;
                background: none;
                user-select: none;
                justify-content: start;
                align-content: start;
            }

            .dot {
                width: 10px;
                height: 10px;
                border-radius: 5px;
                background: radial-gradient(circle at 30% 30%, #222, #000);
                box-shadow: inset -1px -1px 2px rgba(0, 0, 0, 0.8);
                cursor: default;
            }

            .active {
                background: radial-gradient(circle at 30% 30%, var(--dot-color, #ffa200), var(--dot-color, #ffa200));
                box-shadow: 0 0 6px var(--dot-color, #ffa200);
            }

            button {
                background: #444;
                color: white;
                border: none;
                padding: 6px 12px;
                cursor: default;
                border-radius: 14px;
                transition: background 0.2s ease;
            }

            button:hover {
                background: #666;
            }

            .label,
            .label:hover {
                background: #444;
                color: white;
                border: none;
                padding: 6px 12px;
                cursor: default;
                border-radius: 14px;
            }

            .color-wrapper {
                position: relative;
                width: 100%;
                height: 28px;
                border-radius: 14px;
                overflow: hidden;
                box-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
            }

            input[type="color"] {
                appearance: none;
                border: none;
                width: 100%;
                height: 28px;
                cursor: pointer;
                background: none;
                padding: 0;
            }

            input[type="color"]::-webkit-color-swatch-wrapper {
                padding: 0;
                border-radius: 14px;
            }

            input[type="color"]::-webkit-color-swatch {
                border: none;
                border-radius: 14px;
            }

            .text,
            .text:hover {
                border-bottom-right-radius: 5px;
                border-top-right-radius: 5px;
                cursor: default;
                background: #444;
                width: 116px;
            }

            .right {
                border-bottom-left-radius: 5px;
                border-top-left-radius: 5px;
            }

            .left {
                border-bottom-right-radius: 5px;
                border-top-right-radius: 5px;
            }

            .inner {
                border-radius: 5px;
            }

            .outer {
                border-radius: 14px;
            }

            dialog#exportDialog {
                padding: 0;
                border: none;
                background: transparent;
            }

            dialog::backdrop {
                background: rgba(0, 0, 0, 0.6);
            }

            .export-dialog {
                background: #222;
                color: #eee;
                padding: 20px;
                border-radius: 8px;
                width: fit-content;
                max-width: 400px;
                margin: auto;
                box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .export-dialog input[type="text"],
            .export-dialog select {
                background: #333;
                color: #fff;
                border: none;
                padding: 6px 10px;
                border-radius: 4px;
                font-size: 14px;
            }

            .export-dialog label {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }

            .export-dialog .export-buttons {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .export-dialog button {
                background: #444;
                color: #fff;
                border: none;
                padding: 8px 14px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.2s ease;
            }

            .export-dialog button:hover {
                background: #666;
            }

            #optionBackground,
            #optionInactive,
            #optionColor {
                display: none;
            }
        </style>
    </head>

    <body>
        <div id="menu">
            <div class="buttons"><button class="text">Links</button><button class="inner" onclick="addColumnLeft()" style="width: 31px;">+</button><button class="right" onclick="removeColumnLeft()" style="width: 31px;">-</button></div>
            <div class="buttons"><button class="text">Rechts</button><button class="inner" onclick="addColumn()" style="width: 31px;">+</button><button class="right" onclick="removeColumn()" style="width: 31px;">-</button></div>
            <div style="height: 2px;"></div>
            <div class="buttons"><button class="text">Oben</button><button class="inner" onclick="addRowTop()" style="width: 31px;">+</button><button class="right" onclick="removeRowTop()" style="width: 31px;">-</button></div>
            <div class="buttons"><button class="text">Unten</button><button class="inner" onclick="addRow()" style="width: 31px;">+</button><button class="right" onclick="removeRow()" style="width: 31px;">-</button></div>
            <div style="height: 2px;"></div>
            <div><label style="color:white;">
                    <div class="color-wrapper"><input type="color" id="colorPicker" value="#ffa200" onchange="setColor(this.value)"></div>
                </label></div>
            <div style="height: 2px;"></div>
            <div style="color: white; text-align: center; margin-top: 6px;">Zeilen: <span id="rowCounter">15</span>| Spalten: <span id="colCounter">20</span></div><button onclick="startPresentation()" class="outer">Vorführung</button>
            <div class="buttons"><button onclick='document.getElementById("exportDialog").showModal(); updateExportOptions()' class="left" style="width: 50%">Download</button><button class="right" onclick="document.getElementById('importFile').click()" style="width: 50%">Importieren</button><input type="file" id="importFile" accept=".json" style="display:none;"></div>
        </div>
        <div id="matrix-scroll">
            <div id="matrix"></div>
        </div>
        <dialog id="exportDialog">
            <form method="dialog" class="export-dialog"><label for="exportFormat">Format:</label><select id="exportFormat" onchange="updateExportOptions()">
                    <option value="json">JSON (Bearbeitung)</option>
                    <option value="svg">SVG (Vektor)</option>
                    <option value="png">PNG (Bild)</option>
                </select>
                <div id="optionBackground"><label><input type="checkbox" id="includeBackground">Hintergrund einfügen</label></div>
                <div id="optionInactive"><label><input type="checkbox" id="includeInactive">Inaktive Dots einfügen</label></div>
                <div id="optionColor"><label><input type="checkbox" id="includeColor">Farbe übernehmen</label></div><label for="exportFilename">Dateiname:</label><input type="text" id="exportFilename" value="Matrix">
                <div class="export-buttons"><button class="left" onclick="document.getElementById('exportDialog').close()">Abbrechen</button><button class="right" onclick="handleExport()">Exportieren</button></div>
            </form>
        </dialog>
        <script>
            const matrix = document.getElementById("matrix");
            const menu = document.getElementById("menu");
            const scrollBox = document.getElementById("matrix-scroll");
            const rowCounter = document.getElementById("rowCounter");
            const colCounter = document.getElementById("colCounter");
            const colorPicker = document.getElementById("colorPicker");
            const exportDialog = document.getElementById("exportDialog");

            let fullMatrix = [];
            let visibleRows = 15;
            let visibleCols = 20;
            let currentColor = "#ffa200";
            let locked = false;
            let tapCount = 0;
            let tapTimer = null;
            let resizeHandlerAttached = false;
            let isDragging = false;
            let dragMode = null;
            let removedRows = [];
            let removedCols = [];
            let undoStack = [];
            let redoStack = [];

            // === Farbe ===
            function setColor(val) {
                currentColor = val;
                pushState();
                document.documentElement.style.setProperty("--dot-color", currentColor);
                localStorage.setItem("matrixColor", currentColor);
            }

            function loadColor() {
                const savedColor = localStorage.getItem("matrixColor");

                if (savedColor) {
                    currentColor = savedColor;
                    colorPicker.value = savedColor;
                    document.documentElement.style.setProperty("--dot-color", currentColor);
                }
            }

            // === Matrixzustand speichern / laden ===
            function saveMatrixState() {
                localStorage.setItem("matrixRows", visibleRows);
                localStorage.setItem("matrixCols", visibleCols);
                localStorage.setItem("matrixData", JSON.stringify(fullMatrix));
            }

            function loadMatrixState() {
                const rows = parseInt(localStorage.getItem("matrixRows"));
                const cols = parseInt(localStorage.getItem("matrixCols"));
                const data = JSON.parse(localStorage.getItem("matrixData"));

                if (rows && cols) {
                    visibleRows = rows;
                    visibleCols = cols;
                }

                if (Array.isArray(data)) {
                    fullMatrix = data;
                }
            }

            // === Matrix vorbereiten ===
            function initMatrix(rows, cols) {
                for (let y = 0; y < rows; y++) {
                    if (!fullMatrix[y]) fullMatrix[y] = [];

                    for (let x = 0; x < cols; x++) {
                        if (fullMatrix[y][x] === undefined) fullMatrix[y][x] = false;
                    }
                }
            }

            // === Darstellung ===
            function render() {
                initMatrix(visibleRows, visibleCols);
                matrix.style.gridTemplateColumns = `repeat(${visibleCols}, 14px)`;
                matrix.style.gridTemplateRows = `repeat(${visibleRows}, 14px)`;
                matrix.innerHTML = "";

                for (let y = 0; y < visibleRows; y++) {
                    for (let x = 0; x < visibleCols; x++) {
                        const dot = document.createElement("div");
                        dot.className = "dot";
                        if (fullMatrix[y][x]) dot.classList.add("active");

                        dot.addEventListener("mousedown", (e) => {
                            if (locked) return;
                            e.preventDefault();
                            isDragging = true;
                            dragMode = fullMatrix[y][x] ? "deactivate" : "activate";
                            applyToggle(dot, y, x);
                        });

                        dot.addEventListener("mouseenter", () => {
                            if (isDragging && !locked) applyToggle(dot, y, x);
                        });

                        matrix.appendChild(dot);
                    }
                }

                if (rowCounter) rowCounter.textContent = visibleRows;
                if (colCounter) colCounter.textContent = visibleCols;

                saveMatrixState();
            }

            window.addEventListener("mouseup", () => {
                isDragging = false;
                dragMode = null;
            });

            function applyToggle(dot, y, x) {
                const newVal = (dragMode === "activate");

                if (fullMatrix[y][x] !== newVal) {
                    pushState();
                    fullMatrix[y][x] = newVal;
                    dot.classList.toggle("active", newVal);
                    saveMatrixState();
                }
            }

            // === Undo / Redo ===
            function pushState() {
                undoStack.push(JSON.stringify(fullMatrix));
                redoStack = [];
            }

            function undo() {
                if (undoStack.length === 0) return;
                redoStack.push(JSON.stringify(fullMatrix));
                fullMatrix = JSON.parse(undoStack.pop());
                render();
            }

            function redo() {
                if (redoStack.length === 0) return;
                undoStack.push(JSON.stringify(fullMatrix));
                fullMatrix = JSON.parse(redoStack.pop());
                render();
            }

            window.addEventListener("keydown", (e) => {
                if (e.ctrlKey && e.key === "z") {
                    e.preventDefault();
                    undo();
                }

                if (e.ctrlKey && (e.key === "y" || (e.shiftKey && e.key === "Z"))) {
                    e.preventDefault();
                    redo();
                }
            });

            // === Zeilen / Spalten ändern ===
            function addColumn() {
                pushState();

                for (let y = 0; y < visibleRows; y++) {
                    fullMatrix[y].push(false);
                }

                visibleCols++;
                render();
            }

            function removeColumn() {
                if (visibleCols <= 1) return;
                pushState();

                for (let y = 0; y < visibleRows; y++) {
                    fullMatrix[y].pop();
                }

                visibleCols--;
                render();
            }

            function addRow() {
                pushState();
                fullMatrix.push(new Array(visibleCols).fill(false));
                visibleRows++;
                render();
            }

            function removeRow() {
                if (visibleRows <= 1) return;
                pushState();
                fullMatrix.pop();
                visibleRows--;
                render();
            }

            function addColumnLeft() {
                pushState();

                for (let y = 0; y < visibleRows; y++) {
                    fullMatrix[y].unshift(false);
                }

                visibleCols++;
                render();
            }

            function removeColumnLeft() {
                if (visibleCols <= 1) return;
                pushState();

                for (let y = 0; y < visibleRows; y++) {
                    fullMatrix[y].shift();
                }

                visibleCols--;
                render();
            }

            function addRowTop() {
                pushState();
                fullMatrix.unshift(new Array(visibleCols).fill(false));
                visibleRows++;
                render();
            }

            function removeRowTop() {
                if (visibleRows <= 1) return;
                pushState();
                fullMatrix.shift();
                visibleRows--;
                render();
            }

            // === Präsentation ===
            function computeScale() {
                const scaleX = window.innerWidth / matrix.scrollWidth;
                const scaleY = window.innerHeight / matrix.scrollHeight;
                return Math.min(scaleX, scaleY);
            }

            function startPresentation() {
                locked = true;
                menu.style.display = "none";
                scrollBox.classList.add("presentation");
                matrix.classList.add("presentation");
                matrix.style.transform = `scale(${computeScale()})`;
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                tapCount = 0;
                tapTimer = null;
                document.addEventListener("click", handleTap);

                if (!resizeHandlerAttached) {
                    window.addEventListener("resize", handleResizeInPresentation);
                    resizeHandlerAttached = true;
                }
            }

            function handleResizeInPresentation() {
                if (matrix.classList.contains("presentation")) {
                    matrix.style.transform = `scale(${computeScale()})`;
                }
            }

            function handleTap() {
                tapCount++;

                if (!tapTimer) {
                    tapTimer = setTimeout(() => {
                            tapCount = 0;
                            tapTimer = null;
                        }

                        , 2500);
                }

                if (tapCount >= 10) endPresentation();
            }

            function endPresentation() {
                locked = false;
                menu.style.display = "flex";
                scrollBox.classList.remove("presentation");
                matrix.classList.remove("presentation");
                matrix.style.transform = "none";
                if (document.fullscreenElement) document.exitFullscreen();
                document.removeEventListener("click", handleTap);
            }

            function updateExportOptions() {
                const format = document.getElementById("exportFormat").value;

                // Zeige/Verstecke Optionen je nach Format
                document.getElementById("optionBackground").style.display = (format === "svg" || format === "png") ? "block" : "none";
                document.getElementById("optionInactive").style.display = (format === "svg" || format === "png") ? "block" : "none";
                document.getElementById("optionColor").style.display = (format === "json") ? "block" : "none";

                // Standard-Dateiname setzen
                const filenameField = document.getElementById("exportFilename");
                filenameField.value = (format === "json") ? "Export für Matrix" : "Matrix";
            }

            function handleExport() {
                const format = document.getElementById("exportFormat").value;
                const filename = document.getElementById("exportFilename").value || "Matrix";

                const includeBackground = document.getElementById("includeBackground")?.checked || false;
                const includeInactive = document.getElementById("includeInactive")?.checked || false;
                const includeColor = document.getElementById("includeColor")?.checked || false;

                if (format === "json") {
                    exportAsJSON(filename, includeColor);
                } else if (format === "svg") {
                    exportAsSVG(filename, includeBackground, includeInactive);
                } else if (format === "png") {
                    exportAsPNG(filename, includeBackground, includeInactive);
                }

                // Dialog schließen nach Export
                document.getElementById("exportDialog").close();
            }

            // --- JSON-Export ---
            function exportAsJSON(filename, includeColor) {
                const data = {
                    rows: visibleRows,
                    cols: visibleCols,
                    matrix: fullMatrix
                }

                ;
                if (includeColor) data.color = currentColor;

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: "application/json"
                });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = filename + ".json";
                a.click();

                URL.revokeObjectURL(url);
            }

			// === Exportfunktionen mit Glow + Verläufen ===
			// Dots = 10px groß, Abstand = 5px

			function exportAsSVG(filename, includeBackground, includeInactive) {
				const svgNS = "http://www.w3.org/2000/svg";
				const svg = document.createElementNS(svgNS, "svg");
				const dotSize = 10;
				const gap = 5;
				const width = visibleCols * (dotSize + gap);
				const height = visibleRows * (dotSize + gap);

				svg.setAttribute("xmlns", svgNS);
				svg.setAttribute("width", width);
				svg.setAttribute("height", height);
				svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

				// --- <defs> für Verläufe & Glow ---
				const defs = document.createElementNS(svgNS, "defs");

				// Radialer Verlauf für inaktive Dots
				const gradInactive = document.createElementNS(svgNS, "radialGradient");
				gradInactive.setAttribute("id", "gradInactive");
				gradInactive.setAttribute("cx", "30%");
				gradInactive.setAttribute("cy", "30%");
				gradInactive.setAttribute("r", "70%");
				gradInactive.innerHTML = `
					<stop offset="0%" stop-color="#222"/>
					<stop offset="100%" stop-color="#000"/>
				`;
				defs.appendChild(gradInactive);

				// Filter für Glow-Effekt (aktive Dots)
				const glow = document.createElementNS(svgNS, "filter");
				glow.setAttribute("id", "glow");
				glow.innerHTML = `
					<feGaussianBlur stdDeviation="2" result="blur"/>
					<feMerge>
						<feMergeNode in="blur"/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				`;
				defs.appendChild(glow);

				svg.appendChild(defs);

				// --- Hintergrund (optional) ---
				if (includeBackground) {
					const bg = document.createElementNS(svgNS, "rect");
					bg.setAttribute("x", 0);
					bg.setAttribute("y", 0);
					bg.setAttribute("width", width);
					bg.setAttribute("height", height);
					bg.setAttribute("fill", "#111");
					svg.appendChild(bg);
				}

				// --- Punkte ---
				for (let y = 0; y < visibleRows; y++) {
					for (let x = 0; x < visibleCols; x++) {
						const isActive = fullMatrix[y][x];
						if (!isActive && !includeInactive) continue;

						const cx = x * (dotSize + gap) + dotSize / 2;
						const cy = y * (dotSize + gap) + dotSize / 2;
						const r = dotSize / 2;

						const circle = document.createElementNS(svgNS, "circle");
						circle.setAttribute("cx", cx);
						circle.setAttribute("cy", cy);
						circle.setAttribute("r", r);

						if (isActive) {
							circle.setAttribute("fill", currentColor);
							circle.setAttribute("filter", "url(#glow)");
						} else {
							circle.setAttribute("fill", "url(#gradInactive)");
						}

						svg.appendChild(circle);
					}
				}

				// --- Download ---
				const serializer = new XMLSerializer();
				const svgData = serializer.serializeToString(svg);
				const blob = new Blob([svgData], { type: "image/svg+xml" });
				const url = URL.createObjectURL(blob);

				const a = document.createElement("a");
				a.href = url;
				a.download = filename + ".svg";
				a.click();
				URL.revokeObjectURL(url);
			}


			function exportAsPNG(filename, includeBackground, includeInactive) {
				const dotSize = 10;
				const gap = 5;
				const width = visibleCols * (dotSize + gap);
				const height = visibleRows * (dotSize + gap);

				const canvas = document.createElement("canvas");
				canvas.width = width;
				canvas.height = height;
				const ctx = canvas.getContext("2d");

				// Hintergrund
				if (includeBackground) {
					ctx.fillStyle = "#111";
					ctx.fillRect(0, 0, width, height);
				}

				// Dots zeichnen
				for (let y = 0; y < visibleRows; y++) {
					for (let x = 0; x < visibleCols; x++) {
						const isActive = fullMatrix[y][x];
						if (!isActive && !includeInactive) continue;

						const cx = x * (dotSize + gap) + dotSize / 2;
						const cy = y * (dotSize + gap) + dotSize / 2;
						const r = dotSize / 2;

						if (isActive) {
							// Glow-Effekt
							ctx.save();
							ctx.shadowColor = currentColor;
							ctx.shadowBlur = 6;
							ctx.fillStyle = currentColor;
							ctx.beginPath();
							ctx.arc(cx, cy, r, 0, 2 * Math.PI);
							ctx.fill();
							ctx.restore();
						} else {
							// Radialer Verlauf für inaktive Punkte
							const grad = ctx.createRadialGradient(
								cx - r * 0.3, cy - r * 0.3, r * 0.1,
								cx, cy, r
							);
							grad.addColorStop(0, "#222");
							grad.addColorStop(1, "#000");
							ctx.fillStyle = grad;
							ctx.beginPath();
							ctx.arc(cx, cy, r, 0, 2 * Math.PI);
							ctx.fill();
						}
					}
				}

				// Download
				canvas.toBlob(function (blob) {
					const url = URL.createObjectURL(blob);
					const a = document.createElement("a");
					a.href = url;
					a.download = filename + ".png";
					a.click();
					URL.revokeObjectURL(url);
				});
			}

            // --- IMPORT ---
            document.getElementById("importFile").addEventListener("change", function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);

                        if (!Array.isArray(data.matrix)) {
                            alert("Ungültiges Matrix-Format.");
                            return;
                        }

                        // Farbe übernehmen (falls vorhanden)
                        if (typeof data.color === "string") {
                            currentColor = data.color;
                            colorPicker.value = data.color;
                            document.documentElement.style.setProperty("--dot-color", data.color);
                            localStorage.setItem("matrixColor", data.color);
                        }

                        // Matrix übernehmen
                        fullMatrix = data.matrix;
                        visibleRows = typeof data.rows === "number" ? data.rows : fullMatrix.length;
                        visibleCols = typeof data.cols === "number" ? data.cols : fullMatrix[0]?.length || 0;

                        localStorage.setItem("matrixRows", visibleRows);
                        localStorage.setItem("matrixCols", visibleCols);
                        localStorage.setItem("matrixData", JSON.stringify(fullMatrix));

                        render();
                    } catch (err) {
                        alert("Fehler beim Importieren: " + err.message);
                    }
                }

                ;
                reader.readAsText(file);
            });
            loadColor();
            loadMatrixState();
            render();
            window.addEventListener("beforeunload", saveMatrixState);
        </script>
    </body>
    </html>
